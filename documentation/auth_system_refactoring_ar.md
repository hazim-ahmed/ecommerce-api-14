# شرح إعادة هيكلة نظام المصادقة (Authentication System Refactoring)

## نظرة عامة
تم تحديث نظام المصادقة ليعتمد بشكل كلي على قاعدة البيانات لإدارة الرموز (Tokens). سابقاً، كان النظام يعتمد على توقيع الـ JWT فقط، مما يعني أنه بمجرد إصدار التوكن، لا يمكن إيقافه حتى تنتهي صلاحيته الزمنية.
في النظام الجديد، يتم تخزين كل توكن يتم إصداره في جدول `ApiKeys`، ويتم التحقق من وجوده وصلاحيته عند كل طلب.

---

## 1. نموذج البيانات الجديد (ApiKey Model)
تم تعديل ملف `models/apiKey.js` ليحتوي على الحقول التالية:
- **`user_id`**: المفتاح الأجنبي الذي يربط التوكن بالمستخدم.
- **`token`**: نص التوكن (JWT) نفسه.
- **`is_active`**: قيمة منطقي (Boolean) تحدد ما إذا كان التوكن صالحاً للاستخدام أم لا.
- **`expires_at`**: وقت انتهاء صلاحية التوكن.

هذا الجدول هو **المصدر الوحيد للحقيقة**. إذا لم يكن التوكن موجوداً هنا أو كانت حالة `is_active` تساوي `false`، فلن يتم قبول الطلب.

---

## 2. خدمة إدارة التوكن (AuthTokenService)
تم إنشاء ملف خدمة جديد `services/AuthTokenService.js` لفصل منطق التوكن عن المتحكمات (Controllers). وظيفته:
1.  **`generateAndSaveToken(user)`**:
    - يقوم بإنشاء JWT باستخدام `jsonwebtoken`.
    - يحفظ التوكن في جدول `ApiKeys` مع تعيين `is_active = true`.
    - يحسب تاريخ الانتهاء ويخزنه.

2.  **`validateToken(token)`**:
    - يتحقق من صحة توقيع الـ JWT.
    - يبحث عن التوكن في قاعدة البيانات.
    - يرفض التوكن إذا كان غير موجود، أو إذا كانت قيمته `is_active = false`.
    - يرفض التوكن إذا تجاوز تاريخ `expires_at`.

3.  **`revokeToken(token)`**:
    - تُستخدم عند تسجيل الخروج.
    - تقوم بتحديث سجل التوكن في قاعدة البيانات وتجعل `is_active = false`.

---

## 3. طبقة الحماية (Auth Middleware)
تم تحديث `middleware/authMiddleware.js`:
- بدلاً من مجرد فك تشفير التوكن، يقوم الآن باستدعاء `AuthTokenService.validateToken`.
- هذا يضمن أن المستخدم الذي قام بتسجيل الخروج لا يمكنه استخدام التوكن القديم حتى لو كان وقته لم ينتهِ بعد.

---

## 4. المتحكمات (Controllers)
تم تحديث `AuthController.js`:
- **تسجيل الدخول (Login) وتسجيل جديد (Signup)**: بدلاً من إرسال التوكن مباشرة، يقومان باستدعاء `AuthTokenService` لحفظ التوكن في القاعدة أولاً.
- **تسجيل الخروج (Logout)**: تمت إضافة دالة جديدة تستقبل التوكن من الـ Header وتقوم باستدعاء `revokeToken` لتعطيله.

---

## الخلاصة
بهذا التغيير أصبح النظام يدعم:
1.  **تسجيل الخروج الحقيقي (True Logout)**: التوكن يصبح غير صالح فوراً.
2.  **التحكم في الجلسات**: يمكن للإدارة يدوياً تعطيل توكن مستخدم معين من قاعدة البيانات لمنعه من الدخول.
3.  **الأمان العالي**: الاعتماد على الحالة في قاعدة البيانات يمنع استخدام التوكنات المسروقة إذا تم تعطيلها.
